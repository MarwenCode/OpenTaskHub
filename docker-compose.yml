# Liste des services (conteneurs) de l'application
services:
  # Frontend React/Vite
  frontend:
    # Build de l'image depuis le dossier ./frontend
    build:
      context: ./frontend
      dockerfile: Dockerfile
    # Nom explicite du conteneur
    container_name: opentaskhub-frontend
    # Redemarre sauf si tu l'arretes manuellement
    restart: unless-stopped
    # Mappage port hote:conteneur => localhost:5173
    ports:
      - "5173:5173"
    # Variables d'environnement injectees au frontend
    environment:
      # URL API utilisee par axios cote frontend
      VITE_API_URL: http://localhost:5000/api
    # Volumes pour le dev:
    # - code local monte dans /app pour hot reload
    # - volume anonyme pour conserver node_modules du conteneur
    volumes:
      - ./frontend:/app
      - /app/node_modules
    # Demarre frontend apres backend (ordre simple, pas attente de "ready")
    depends_on:
      - backend

  # Backend Node/Express
  backend:
    # Build de l'image depuis le dossier ./backend
    build:
      context: ./backend
      dockerfile: Dockerfile
    # Nom explicite du conteneur
    container_name: opentaskhub-backend
    # Redemarre sauf si tu l'arretes manuellement
    restart: unless-stopped
    # Mappage port hote:conteneur => localhost:5000
    ports:
      - "5000:5000"
    # Variables d'environnement pour l'API
    environment:
      # Port d'ecoute de l'API dans le conteneur
      PORT: ${PORT:-5000}
      # Mode runtime Node
      NODE_ENV: ${NODE_ENV:-development}
      # Connexion Postgres (le host = nom du service DB dans Compose)
      DB_HOST: ${DB_HOST:-db}
      DB_PORT: ${DB_PORT:-5432}
      DB_NAME: ${DB_NAME:-opentaskhub}
      DB_USER: ${DB_USER:-postgres}
      DB_PASSWORD: ${POSTGRES_PASSWORD}
      # Secrets applicatifs charges depuis .env local (non versionne)
      JWT_SECRET: ${JWT_SECRET}
      ADMIN_SECRET: ${ADMIN_SECRET}
    # Attend que la DB soit "healthy" avant de lancer backend
    depends_on:
      db:
        condition: service_healthy

  # Base de donnees PostgreSQL
  db:
    # Image officielle Postgres
    image: postgres:16
    # Nom explicite du conteneur
    container_name: opentaskhub-db
    # Redemarre sauf si tu l'arretes manuellement
    restart: unless-stopped
    # Variables d'initialisation de la base
    environment:
      POSTGRES_USER: ${POSTGRES_USER:-postgres}
      POSTGRES_PASSWORD: ${POSTGRES_PASSWORD}
      POSTGRES_DB: ${POSTGRES_DB:-opentaskhub}
    # Port hote pour se connecter a Postgres depuis la machine
    ports:
      - "5432:5432"
    # Volume persistant pour conserver les donnees DB
    volumes:
      - db-data:/var/lib/postgresql/data
    # Verifie que Postgres accepte les connexions
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U postgres -d opentaskhub"]
      interval: 5s
      timeout: 5s
      retries: 10

# Definition des volumes nommes utilises plus haut
volumes:
  db-data:
